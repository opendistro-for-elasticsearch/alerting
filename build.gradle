/*
 *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *   
 *   Licensed under the Apache License, Version 2.0 (the "License").
 *   You may not use this file except in compliance with the License.
 *   A copy of the License is located at
 *   
 *       http://www.apache.org/licenses/LICENSE-2.0
 *   
 *   or in the "license" file accompanying this file. This file is distributed 
 *   on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either 
 *   express or implied. See the License for the specific language governing 
 *   permissions and limitations under the License.
 */

buildscript {
    apply from: 'build-tools/amazon-sandbox.gradle'
    apply from: 'build-tools/dependencies.gradle'
    apply from: 'build-tools/repositories.gradle'

    // This isn't applying from repositories.gradle so repeating it here
    repositories {
        if (sandboxedBuild) {
            maven { url offlineRepositoryRoot }
        } else {
            mavenCentral()
            maven { url "https://plugins.gradle.org/m2/" }
        }
    }
    dependencies {
        classpath "org.elasticsearch.gradle:build-tools:${es_version}"
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:${kotlin_version}"
    }
}

apply plugin: 'base'
apply plugin: 'jacoco'
apply from: 'build-tools/brazil.gradle'
apply from: 'build-tools/prepare-offline-repo.gradle'
apply from: 'build-tools/merged-coverage.gradle'

allprojects {
    group = 'com.amazon.opendistro'
    version = es_version

    apply from: "$rootDir/build-tools/repositories.gradle"

    plugins.withId('java') {
        sourceCompatibility = targetCompatibility = "1.8"
    }
    plugins.withId('org.jetbrains.kotlin.jvm') {
        compileKotlin.kotlinOptions.jvmTarget = compileTestKotlin.kotlinOptions.jvmTarget = "1.8"
    }
}

evaluationDependsOnChildren()

task release(type: Copy, group: 'build') {
    dependsOn allprojects*.tasks.build
    from(zipTree(findProject(':monitoring').tasks.bundlePlugin.outputs.files.getSingleFile()))
    into "build/plugins/${es_mv}/opendistro-alerting"
    includeEmptyDirs = false
    // ES versions < 6.3 have a top-level elasticsearch directory inside the plugin zip which we need to remove
    eachFile { it.path = it.path - "elasticsearch/" }
    // Codebuild can't run ES as root so we can't run tests there. In that case depend on assemble
//    dependsOn project(':monitoring').tasks.assemble
}

check.dependsOn subprojects*.check